name: Build and Deploy to EC2

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ‚¨áÔ∏è Checkout code
        uses: actions/checkout@v3

      - name: ‚òï Set up Java 19
        uses: actions/setup-java@v3
        with:
          java-version: '19'
          distribution: 'temurin'

      - name: ‚úÖ Give execute permission to mvnw
        run: chmod +x mvnw

      - name: ‚öôÔ∏è Build Spring Boot Project (skip tests)
        run: ./mvnw clean package -DskipTests

      - name: üì§ Upload JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          source: target/Room_Management_System-0.0.1-SNAPSHOT.jar
          target: /home/ec2-user/

      - name: Deploy and Run Spring Boot JAR on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 300s
          command_timeout: 20m
          script: |
            echo "=== Starting New Deployment ==="
            echo "Timestamp: $(date)"
            
            echo "=== Verifying File Transfer ==="
            ls -la /home/ec2-user/
            
            # Determine JAR path
            if [ -f "/home/ec2-user/target/Room_Management_System-0.0.1-SNAPSHOT.jar" ]; then
              JAR_PATH="/home/ec2-user/target/Room_Management_System-0.0.1-SNAPSHOT.jar"
            elif [ -f "/home/ec2-user/Room_Management_System/target/Room_Management_System-0.0.1-SNAPSHOT.jar" ]; then
              JAR_PATH="/home/ec2-user/Room_Management_System/target/Room_Management_System-0.0.1-SNAPSHOT.jar"
            else
              echo "‚ùå JAR file not found!"
              exit 1
            fi
            echo "‚úÖ JAR found at $JAR_PATH"

            echo "=== Setting Environment Variables ==="
            
            # Kill existing application process
            echo "=== Cleaning up previous deployment ==="
            if [ -f "app.pid" ]; then
              OLD_PID=$(cat app.pid)
              if kill -0 $OLD_PID 2>/dev/null; then
                echo "Killing previous process PID: $OLD_PID"
                kill $OLD_PID
                sleep 3
              fi
            fi
            
            export MONGO_URI="${{ secrets.MONGO_URI }}"
            export MAIL_USERNAME="${{ secrets.MAIL_USERNAME }}"
            export MAIL_PASSWORD="${{ secrets.MAIL_PASSWORD }}"
            export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
            export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
            export AWS_REGION="${{ secrets.AWS_REGION }}"
            export AWS_S3_BUCKET="${{ secrets.AWS_S3_BUCKET }}"
            export FRONTEND_URL="${{ secrets.FRONTEND_URL }}"
            echo "FRONTEND_URL set to: $FRONTEND_URL"
            
            echo "=== Starting Application ==="
            # Clear previous logs
            > output.log

            # Start Spring Boot application
            nohup java -jar "$JAR_PATH" > output.log 2>&1 &
            JAVA_PID=$!
            echo $JAVA_PID > app.pid
            echo "Application started with PID: $JAVA_PID"

            # Wait for app to start - increased attempts and better detection
            for i in {1..120}; do
              if kill -0 $JAVA_PID 2>/dev/null; then
                if grep -q "Started RoomManagementSystemApplication" output.log; then
                  echo "‚úÖ Application started successfully!"
                  echo "=== Final Status ==="
                  echo "PID: $JAVA_PID"
                  echo "Recent logs:"
                  tail -20 output.log
                  exit 0
                elif grep -q "ERROR\|Application run failed" output.log && ! grep -q "Unable to proxy interface-implementing method" output.log && ! grep -q "UserDetailsService beans will not be used" output.log; then
                  echo "‚ùå Application startup errors detected"
                  echo "=== Error Logs ==="
                  tail -50 output.log
                  echo "=== Full Error Context ==="
                  grep -A 10 -B 5 "ERROR\|Application run failed" output.log || echo "No error patterns found"
                  exit 1
                fi
            
                # Show progress every 15 attempts
                if [ $((i % 15)) -eq 0 ]; then
                  echo "=== Current Logs (attempt $i/120) ==="
                  tail -10 output.log
                fi
              else
                echo "‚ùå Process died unexpectedly"
                cat output.log
                exit 1
              fi
              sleep 2
            done

            echo "‚ö†Ô∏è Application startup timeout - process may still be running"
            tail -50 output.log